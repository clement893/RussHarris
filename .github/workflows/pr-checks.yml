name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

env:
  PNPM_VERSION: 9.15.9
  NODE_VERSION: 20.x

jobs:
  pr-checks:
    name: PR Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint
        continue-on-error: false

      - name: Run type check
        run: pnpm type-check
        continue-on-error: false

      - name: Check formatting
        run: pnpm format:check
        continue-on-error: false

      - name: Run frontend tests
        run: pnpm test:web
        continue-on-error: false

      - name: Check test coverage
        run: pnpm test:web:coverage
        continue-on-error: false

      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let coverageComment = '## âœ… PR Checks Completed\n\n';
            
            // Check if coverage report exists
            const coveragePath = path.join(process.cwd(), 'apps/web/coverage/coverage-summary.json');
            if (fs.existsSync(coveragePath)) {
              const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
              const totals = coverage.total;
              
              coverageComment += `### ðŸ“Š Test Coverage\n\n`;
              coverageComment += `| Metric | Coverage |\n`;
              coverageComment += `|--------|----------|\n`;
              coverageComment += `| Lines | ${(totals.lines.pct || 0).toFixed(2)}% |\n`;
              coverageComment += `| Functions | ${(totals.functions.pct || 0).toFixed(2)}% |\n`;
              coverageComment += `| Branches | ${(totals.branches.pct || 0).toFixed(2)}% |\n`;
              coverageComment += `| Statements | ${(totals.statements.pct || 0).toFixed(2)}% |\n\n`;
            }
            
            coverageComment += `### ðŸ” Checks\n\n`;
            coverageComment += `- âœ… Linting\n`;
            coverageComment += `- âœ… Type Checking\n`;
            coverageComment += `- âœ… Formatting\n`;
            coverageComment += `- âœ… Tests\n`;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('PR Checks Completed')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: coverageComment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: coverageComment
              });
            }

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm build:web
        env:
          NODE_ENV: production

      - name: Build types
        run: pnpm build:types

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm/pnpm security audit
        run: pnpm audit --audit-level=moderate || (echo "Security vulnerabilities found. Review and fix before merging." && exit 1)

      - name: Run comprehensive security audit
        run: pnpm audit:security
        continue-on-error: true

      - name: Setup Python for backend security scan
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python security scanner
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run Python dependency security scan
        working-directory: ./backend
        run: |
          pip-audit --desc || (echo "Python security vulnerabilities found. Review and fix before merging." && exit 1)
        continue-on-error: false

